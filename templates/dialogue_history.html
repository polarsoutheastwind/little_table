<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/CSS/all.css">
    <link rel="stylesheet" href="/static/CSS/dialogue_history.css">
    <title>聊天记录</title>
</head>
<body>
<div class="header">
    <span class="login-status">{{ session['user_now']['username'] }} 已登录 <a href="/login_out">退出</a></span>
</div>
       <main>
        <aside>
            <div class="filters">
                {% if session['user_now']['identity']!="student" %}
                <label for="username">用户名:</label>
                <input type="text" id="username">
                {% endif %}
                <label for="start">开始时间:</label>
                <input type="datetime-local" id="start">

                <label for="end">结束时间:</label>
                <input type="datetime-local" id="end">

                <button onclick="fetchChatRecords()">筛选记录</button>
                <a href="/ai_testing" class="return-button">返回AI问答</a>
            </div>
        </aside>

        <div class="chat-records-container" id="chat-records">
            <!-- 聊天记录将在这里显示 -->
        </div>
    </main>

    <script>
        function fetchChatRecords() {
            const startTime = document.getElementById('start').value;
            const endTime = document.getElementById('end').value;
            const username = document.getElementById('username').value;
            let payload = {
        username: String(username),  // 确保是字符串
        start_time: String(startTime),
        end_time: String(endTime)
    };
            fetch('/dialogue_history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                const chatRecordsContainer = document.getElementById('chat-records');
                chatRecordsContainer.innerHTML = '';

                // 分组聊天记录按 conversation_id
                const conversations = {};
                data.forEach(record => {
                    const conversationId = record.conversation_id;
                    if (!conversations[conversationId]) {
                        conversations[conversationId] = [];
                    }
                    conversations[conversationId].push(record);
                });

                // 显示聊天记录
                for (let conversationId in conversations) {
                    const conversationDiv = document.createElement('div');
                    conversationDiv.className = 'conversation';

                    const conversationTitle = document.createElement('h3');
                    conversationTitle.innerText = `对话ID: ${conversationId}`;
                    conversationDiv.appendChild(conversationTitle);

                    conversations[conversationId].forEach(record => {
                        const chatRecord = document.createElement('div');
                        chatRecord.className = 'chat-record';
                        chatRecord.innerHTML = `
                            <strong>消息序号: ${record.message_index}</strong>
                            <strong>时间: ${record.timestamp}</strong>
                            <strong>用户名: ${record.username}</strong>
                            <p><strong>用户消息:</strong> ${record.user_message}</p>
                            <p><strong>助手回复:</strong> ${record.assistant_reply}</p>
                        `;
                        conversationDiv.appendChild(chatRecord);
                    });

                    chatRecordsContainer.appendChild(conversationDiv);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>
